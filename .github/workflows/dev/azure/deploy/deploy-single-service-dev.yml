name: azure-img-deploy-dev

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag a desplegar (latest, vX.Y, o SHA)"
        required: false
        default: latest
  workflow_call:
    inputs:
      tag:
        type: string
        required: false
        default: latest

permissions:
  contents: read
  packages: read

env:
  SSH_HOST: ${{ secrets.SSH_HOST_DEV }}
  SSH_USER: ${{ secrets.SSH_USER }}
  SSH_PORT: ${{ secrets.SSH_PORT || 22 }}
  DEPLOY_DIR: /opt/app

jobs:
  wait_ssh:
    runs-on: ubuntu-latest
    steps:
      - name: Wait SSH
        run: |
          echo "Waiting SSH on ${{ env.SSH_HOST }}:${{ env.SSH_PORT }} ..."
          for i in {1..60}; do
            if nc -z ${{ env.SSH_HOST }} ${{ env.SSH_PORT }}; then
              echo "SSH up."; exit 0
            fi
            sleep 5
          done
          echo "Timeout waiting SSH." && exit 1

  deploy:
    runs-on: ubuntu-latest
    needs: [wait_ssh]
    steps:
      - uses: actions/checkout@v4

      - name: Img calculation (lowercase GHCR)
        id: img
        shell: bash
        run: |
          set -euo pipefail

          REPO_LC="$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')"
          IMAGE="ghcr.io/${REPO_LC}-dev"

          TAG="${{ inputs.tag || 'latest' }}"

          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG"     >> "$GITHUB_OUTPUT"

      - name: Setup SSH key for SCP
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Copy deploy-compose-dev.yml to VM
        run: |
          scp -o StrictHostKeyChecking=no -P ${{ env.SSH_PORT }} \
            ./deploy-compose-dev.yml \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:${{ env.DEPLOY_DIR }}/deploy-compose-dev.yml

      - name: Deploy by SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          port: ${{ env.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -euo pipefail
            IMAGE="${{ steps.img.outputs.image }}"
            TAG="${{ steps.img.outputs.tag }}"

            sudo mkdir -p "${{ env.DEPLOY_DIR }}"
            cd "${{ env.DEPLOY_DIR }}"

            echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

            export IMAGE="$IMAGE"
            export TAG="$TAG"

            docker compose -f deploy-compose-dev.yml pull
            docker compose -f deploy-compose-dev.yml up -d --remove-orphans
            docker image prune -af || true